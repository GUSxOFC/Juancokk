<!doctype html>

<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Run Bot — Simple Runner</title>
  <style>
    :root{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;}
    body{margin:0;background:#0f172a;color:#e6eef8;padding:18px}
    .card{background:#0b1220;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,.6);}
    h1{margin:0 0 12px;font-size:20px}
    label{display:block;margin:8px 0 4px;font-size:13px;color:#9fb0d9}
    textarea{width:100%;height:160px;background:#071026;border:1px solid #123;background-clip:padding-box;color:#dbeafe;padding:10px;border-radius:8px}
    .row{display:flex;gap:8px;align-items:center}
    button{background:#2563eb;border:none;padding:8px 12px;border-radius:8px;color:white;cursor:pointer}
    button.ghost{background:transparent;border:1px solid #274f7f;color:#a9c7ff}
    input[type=file]{color:#cfe3ff}
    .file-list,.queue{margin-top:8px;background:#061225;border-radius:8px;padding:8px;min-height:44px}
    .file-item{display:flex;justify-content:space-between;padding:6px 8px;border-radius:6px}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#0b3b6b}
    .controls{display:flex;gap:8px;margin-top:12px}
    .hidden{display:none}
    .warning{background:#3a1f12;color:#ffd7c4;padding:8px;border-radius:6px;margin-top:8px}
    .log{height:160px;overflow:auto;background:#021127;border-radius:8px;padding:8px;color:#a9d1ff;font-family:monospace;font-size:13px}
    .pill{background:#0b3b6b;padding:6px 8px;border-radius:999px}
  </style>
</head>
<body>
  <div class="card" id="main">
    <h1>Run Bot — Runner Lokal</h1>
    <div id="setup">
      <label>Masukan script yang mau di run (JavaScript)</label>
      <textarea id="scriptInput" placeholder="// tulis script JS di sini\nconsole.log('bot running')"></textarea><div class="row" style="margin-top:8px">
    <input type="checkbox" id="antiSim" checked />
    <label for="antiSim" style="margin:0 0 0 6px;cursor:pointer">Aktifkan anti-simulasi (heuristik deteksi headless)</label>
  </div>

  <label style="margin-top:10px">Pilih file (multiple) — pilih 'semua' bila perlu</label>
  <div class="row">
    <input id="fileInput" type="file" multiple />
    <button id="selectAllBtn" class="ghost">Pilih semua</button>
    <button id="unarchiveBtn">^</button>
    <button id="moveBtn">Move</button>
  </div>

  <div class="file-list" id="fileList">Belum ada file yang dipilih</div>

  <div class="controls">
    <button id="goRun">Ke Halaman Run</button>
    <button id="downloadScript" class="ghost">Download script</button>
  </div>

  <div id="simWarning" class="warning hidden"></div>
</div>

<div id="runner" class="hidden" style="margin-top:14px">
  <h2 style="font-size:16px">Run Page</h2>
  <div class="row">
    <button id="startBtn">Start bot</button>
    <button id="restartBtn" class="ghost">Ulang / Refresh</button>
    <button id="stopBtn" class="ghost">Stop</button>
    <span class="pill" id="status">stopped</span>
  </div>

  <label style="margin-top:10px">Queue (dipindahkan dari file)</label>
  <div class="queue" id="queue">Kosong</div>

  <label style="margin-top:10px">Output / Logs</label>
  <div id="logs" class="log"></div>

  <div style="margin-top:8px">
    <button id="backBtn" class="ghost">Kembali ke Setup</button>
  </div>
</div>

  </div><script>
(() => {
  const scriptInput = document.getElementById('scriptInput');
  const fileInput = document.getElementById('fileInput');
  const fileList = document.getElementById('fileList');
  const queueEl = document.getElementById('queue');
  const moveBtn = document.getElementById('moveBtn');
  const selectAllBtn = document.getElementById('selectAllBtn');
  const unarchiveBtn = document.getElementById('unarchiveBtn');
  const goRun = document.getElementById('goRun');
  const runner = document.getElementById('runner');
  const setup = document.getElementById('setup');
  const startBtn = document.getElementById('startBtn');
  const restartBtn = document.getElementById('restartBtn');
  const stopBtn = document.getElementById('stopBtn');
  const status = document.getElementById('status');
  const logs = document.getElementById('logs');
  const backBtn = document.getElementById('backBtn');
  const antiSim = document.getElementById('antiSim');
  const simWarning = document.getElementById('simWarning');
  const downloadScript = document.getElementById('downloadScript');

  let selectedFiles = []; // {name, archived, file}
  let queue = [];
  let iframe = null;

  function renderFileList(){
    if(selectedFiles.length===0){ fileList.textContent='Belum ada file yang dipilih'; return }
    fileList.innerHTML='';
    selectedFiles.forEach((f,idx)=>{
      const d = document.createElement('div'); d.className='file-item';
      d.innerHTML = `<div><input type=checkbox data-idx=${idx} id='cb${idx}' ${f.checked?'checked':''}/> <label for='cb${idx}'>${f.name}</label></div><div>${f.archived?'<span class="badge">archived</span>':''}</div>`;
      fileList.appendChild(d);
    });
  }

  fileInput.addEventListener('change', e=>{
    const files = Array.from(e.target.files);
    files.forEach(f=> selectedFiles.push({name:f.name, archived:false, file:f}));
    renderFileList();
  });

  selectAllBtn.addEventListener('click', ()=>{
    selectedFiles = selectedFiles.map(s=>({...s, checked:true}));
    renderFileList();
  });

  unarchiveBtn.addEventListener('click', ()=>{
    // toggle archived for selected checkboxes
    const checks = fileList.querySelectorAll('input[type=checkbox]');
    checks.forEach(cb=>{
      if(cb.checked){
        const idx = Number(cb.dataset.idx);
        selectedFiles[idx].archived = !selectedFiles[idx].archived;
      }
    });
    renderFileList();
  });

  moveBtn.addEventListener('click', ()=>{
    // move selected files to queue
    const checks = fileList.querySelectorAll('input[type=checkbox]');
    const moved = [];
    checks.forEach(cb=>{
      if(cb.checked){
        const idx = Number(cb.dataset.idx);
        moved.push(selectedFiles[idx]);
      }
    });
    if(moved.length===0){ alert('Pilih file dulu (atau "Pilih semua")'); return }
    // simulate move
    moved.forEach(m=>{
      queue.push(m);
      // remove from selectedFiles
      const i = selectedFiles.indexOf(m);
      if(i>-1) selectedFiles.splice(i,1);
    });
    renderFileList();
    renderQueue();
    // go to run
    setup.classList.add('hidden');
    runner.classList.remove('hidden');
    status.textContent='stopped';
  });

  function renderQueue(){
    if(queue.length===0){ queueEl.textContent='Kosong'; return }
    queueEl.innerHTML='';
    queue.forEach((q,idx)=>{
      const d=document.createElement('div'); d.className='file-item';
      d.innerHTML = `<div>${idx+1}. ${q.name}</div><div>${q.archived?'<span class="badge">archived</span>':''}</div>`;
      queueEl.appendChild(d);
    });
  }

  goRun.addEventListener('click', ()=>{
    setup.classList.add('hidden');
    runner.classList.remove('hidden');
    renderQueue();
  });

  backBtn.addEventListener('click', ()=>{
    runner.classList.add('hidden');
    setup.classList.remove('hidden');
  });

  function detectHeadless(){
    // simple heuristics
    try{
      const webdriver = navigator.webdriver || false;
      const userAgent = navigator.userAgent || '';
      const plugins = navigator.plugins ? navigator.plugins.length : 0;
      const languages = navigator.languages || [];
      const headlessUA = /HeadlessChrome|PhantomJS|SlimerJS/i.test(userAgent);
      const probablyHeadless = webdriver || headlessUA || plugins===0 || languages.length===0;
      return {detected:probablyHeadless, reason:{webdriver, userAgent, plugins, languages}};
    }catch(e){
      return {detected:false, reason:null};
    }
  }

  function ensureNotSimulated(){
    if(!antiSim.checked) return true;
    const res = detectHeadless();
    if(res.detected){
      simWarning.classList.remove('hidden');
      simWarning.textContent = 'Peringatan: lingkungan tampak seperti simulasi/headless — menjalankan script diblokir.';
      return false;
    }
    simWarning.classList.add('hidden');
    return true;
  }

  function createRunnerIframe(code){
    // create sandboxed iframe using srcdoc to isolate execution
    const wrapper = document.createElement('div');
    wrapper.style.marginTop='10px';
    const ifr = document.createElement('iframe');
    ifr.setAttribute('sandbox','allow-scripts');
    ifr.style.width='100%'; ifr.style.height='320px'; ifr.style.border='1px solid #123'; ifr.id='botiframe';

    const html = `<!doctype html><html><body><script>
// capture console
(function(){
  function send(type,args){
    parent.postMessage({type, args: Array.from(args).map(a=>{ try{ return JSON.stringify(a) }catch(e){ return String(a) }})}, '*');
  }
  const c = console;
  console.log = function(){ send('log', arguments); c.log.apply(c, arguments); };
  console.error = function(){ send('error', arguments); c.error.apply(c, arguments); };
  console.warn = function(){ send('warn', arguments); c.warn.apply(c, arguments); };
})();

// user script starts
try{
  ${code}
}catch(e){ console.error('Error in user script:', e); }
</script></body></html>`;ifr.srcdoc = html;
wrapper.appendChild(ifr);
// remove old
const old = document.getElementById('botiframe');
if(old) old.parentElement.removeChild(old);
document.getElementById('runner').appendChild(ifr);
return ifr;

}

window.addEventListener('message', e=>{ const data = e.data || {}; if(data.type){ const text = data.args.join(' '); appendLog([${data.type.toUpperCase()}] ${text}); } });

function appendLog(txt){ const p = document.createElement('div'); p.textContent = txt; logs.appendChild(p); logs.scrollTop = logs.scrollHeight; }

startBtn.addEventListener('click', ()=>{ if(!ensureNotSimulated()) return; const code = scriptInput.value || "console.log('tidak ada script')"; // include files content as consts (best-effort) let filesCode = ''; queue.forEach((q,idx)=>{ // we cannot read File content here unless File is accessible; some browsers allow access via FileReader if(q.file){ // sync placeholder — real content will be read and injected into code when available filesCode += \n/* FILE: ${q.name} */\n; } }); const full = ${filesCode}\n${code}; iframe = createRunnerIframe(full); status.textContent='running'; appendLog('Bot started'); });

restartBtn.addEventListener('click', ()=>{ if(!iframe){ appendLog('Belum start'); return } if(!ensureNotSimulated()) return; // reload by recreating iframe const code = scriptInput.value || "console.log('tidak ada script')"; const full = ${code}; iframe = createRunnerIframe(full); status.textContent='running'; appendLog('Bot restarted'); });

stopBtn.addEventListener('click', ()=>{ const ifr = document.getElementById('botiframe'); if(ifr){ ifr.remove(); appendLog('Bot stopped'); status.textContent='stopped'; iframe=null; } else appendLog('Bot already stopped'); });

downloadScript.addEventListener('click', ()=>{ const blob = new Blob([scriptInput.value || ''], {type:'text/javascript'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='script.js'; a.click(); });

// small UX: read small files into queue entries so iframe can access if needed async function readFileContents(fileObj){ if(!fileObj.file) return null; return await new Promise((res, rej)=>{ const fr = new FileReader(); fr.onload = ()=>res(fr.result); fr.onerror = ()=>res(null); fr.readAsText(fileObj.file); }); }

// when moving to queue, attempt to read files // (we already moved earlier; add a small step: populate file contents) async function populateQueueContents(){ for(let i=0;i<queue.length;i++){ if(queue[i].file && !queue[i].content){ queue[i].content = await readFileContents(queue[i]); } } }

// call populate in background (user-visible but local) setInterval(populateQueueContents, 1500);

})(); </script>

</body>
  </html>
